parameters:
- name: runTests
  type: boolean
  default: true
- name: os
  type: string
  default: ''

steps:
# Build .NET project only on Windows (PowerShell Core can run on all platforms but C# compilation is Windows-specific for this project)
- ${{ if or(eq(parameters.os, 'Windows_NT'), eq(variables['Agent.OS'], 'Windows_NT')) }}:
  - task: DotNetCoreCLI@2
    displayName: 'Build .NET project(s)'
    inputs:
      command: build
      projects: 'powershell/CompiledHelpers/VstsTaskSdk.csproj'
      arguments: '--configuration Release'

# Use Node.js 20.x for PowerShell SDK (required for newer dependencies)
- task: NodeTool@0
  displayName: use node $(nodeVersionForPowershell) for PowerShell SDK
  inputs:
    versionSpec: $(nodeVersionForPowershell)

- task: NpmAuthenticate@0
  inputs:
    workingFile: .npmrc

- script: npm ci
  displayName: (VstsTaskSdk) npm ci
  workingDirectory: powershell

# Build the PowerShell module
- script: node make.js build
  displayName: (VstsTaskSdk) build module
  workingDirectory: powershell

# Run tests if requested
- ${{ if eq(parameters.runTests, true) }}:
  - script: npm test
    displayName: (VstsTaskSdk) npm test
    workingDirectory: powershell